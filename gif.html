<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Video to GIF</title>
    <script src="https://cdn.jsdelivr.net/npm/gif.js.optimized/dist/gif.js"></script>
  </head>
  <body>
    <h2>Select Start Time and Make a GIF</h2>

    <video id="video" width="320" controls>
      <source src="./vids/p-21.mp4" type="video/mp4" />
      Your browser does not support the video tag.
    </video>

    <br /><br />
    <button id="makeGifBtn">Generate GIF (3 sec from current time)</button>
    <p id="status"></p>
    <img id="gifPreview" alt="Generated GIF will appear here" />

    <script>
      const video = document.getElementById("video");
      const btn = document.getElementById("makeGifBtn");
      const statusText = document.getElementById("status");
      const gifPreview = document.getElementById("gifPreview");

      async function seekTo(time) {
        return new Promise((resolve, reject) => {
          const onSeeked = () => {
            clearTimeout(timeout);
            video.removeEventListener("seeked", onSeeked);
            resolve();
          };
          const timeout = setTimeout(() => {
            video.removeEventListener("seeked", onSeeked);
            reject(new Error("Seek timed out"));
          }, 3000);

          video.addEventListener("seeked", onSeeked);
          video.currentTime = time;
        });
      }
      btn.addEventListener("click", async () => {

        // Inside your button click handler
        

        const gif = new GIF({
          workers: 2,
          quality: 10,
          width: video.videoWidth,
          height: video.videoHeight,
        });

        statusText.textContent = "Generating GIF...";

        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d", { willReadFrequently: true });
const startTime = Math.min(video.duration - 3, video.currentTime);
        const totalFrames = 30;
        for (let i = 0; i < totalFrames; i++) {
          const time = startTime + i / 10;
          try {
            await seekTo(time);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            gif.addFrame(ctx, { copy: true, delay: 100 });
          } catch (err) {
            console.warn("Seek failed at", time, err);
          }
        }
        let currentTime = video.currentTime;
        const fps = 10;
        const duration = 3; // seconds
        const frameCount = fps * duration;

        for (let i = 0; i < frameCount; i++) {
          video.currentTime = currentTime + i / fps;

          // Wait for frame to be rendered
          await new Promise((resolve) =>
            video.addEventListener("seeked", resolve, { once: true })
          );

          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          gif.addFrame(ctx, { copy: true, delay: 100 });
        }

        gif.on("finished", (blob) => {
          const url = URL.createObjectURL(blob);
          console.log("GIF URL:", url);

          gifPreview.src = url;

          // Create download link
          const a = document.createElement("a");
          a.href = url;
          a.download = "video.gif";
          a.textContent = "Download GIF";
          a.style.display = "block";
          document.body.appendChild(a);

          statusText.textContent = "GIF ready!";
        });

        gif.render();
      });
    </script>
  </body>
</html>
